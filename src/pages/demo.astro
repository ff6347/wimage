---
// ABOUTME: Demo page with automatic chained workflow from image capture to visualization
// ABOUTME: Chains all API calls automatically and displays final result in fullscreen
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Wimage Demo - Automatic Workflow</title>
	</head>
	<body>
		<div class="camera-container" id="cameraContainer">
			<video id="video" autoplay playsinline></video>
			<canvas id="canvas" style="display: none;"></canvas>

			<div class="controls">
				<button id="startCamera">Start Camera</button>
				<button id="capture" disabled>Capture Image</button>
			</div>

			<div class="loading-section" id="loadingSection" style="display: none;">
				<div class="loading-spinner"></div>
				<p id="loadingMessage">Processing...</p>
			</div>
		</div>

		<div id="visualizationContainer" style="display: none;"></div>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			html, body {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				background: #f5f5f5;
			}

			.camera-container {
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}

			video {
				width: 100%;
				max-width: 640px;
				border: 2px solid #333;
				border-radius: 8px;
				display: block;
				margin: 0 auto;
			}

			.controls {
				margin: 20px 0;
				display: flex;
				gap: 10px;
				justify-content: center;
			}

			button {
				padding: 10px 20px;
				font-size: 16px;
				cursor: pointer;
				background-color: #0066cc;
				color: white;
				border: none;
				border-radius: 4px;
				transition: background-color 0.2s;
			}

			button:disabled {
				background-color: #ccc;
				cursor: not-allowed;
			}

			button:hover:not(:disabled) {
				background-color: #0052a3;
			}

			.loading-section {
				margin-top: 40px;
				text-align: center;
			}

			.loading-spinner {
				width: 60px;
				height: 60px;
				margin: 0 auto 20px;
				border: 4px solid #f3f3f3;
				border-top: 4px solid #0066cc;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			#loadingMessage {
				font-size: 18px;
				color: #333;
				margin: 10px 0;
			}

			#visualizationContainer {
				width: 100%;
				height: 100vh;
				position: fixed;
				top: 0;
				left: 0;
				background: white;
				z-index: 9999;
			}

			#visualizationContainer iframe {
				width: 100%;
				height: 100%;
				border: none;
			}
		</style>

		<script>
			interface WikiArticle {
				title: string;
				text: string;
			}

			interface Summary {
				title: string;
				summary: string;
			}

			let stream: MediaStream | null = null;
			let capturedBlob: Blob | null = null;

			const video = document.getElementById("video") as HTMLVideoElement;
			const canvas = document.getElementById("canvas") as HTMLCanvasElement;
			const startCameraBtn = document.getElementById("startCamera") as HTMLButtonElement;
			const captureBtn = document.getElementById("capture") as HTMLButtonElement;
			const cameraContainer = document.getElementById("cameraContainer") as HTMLDivElement;
			const loadingSection = document.getElementById("loadingSection") as HTMLDivElement;
			const loadingMessage = document.getElementById("loadingMessage") as HTMLParagraphElement;
			const visualizationContainer = document.getElementById("visualizationContainer") as HTMLDivElement;

			function updateLoadingMessage(message: string) {
				loadingMessage.textContent = message;
			}

			function showLoading() {
				loadingSection.style.display = "block";
			}

			function hideCamera() {
				video.style.display = "none";
				document.querySelector(".controls")?.setAttribute("style", "display: none;");
			}

			startCameraBtn.addEventListener("click", async () => {
				try {
					stream = await navigator.mediaDevices.getUserMedia({
						video: { facingMode: "user" },
					});
					video.srcObject = stream;
					captureBtn.disabled = false;
					startCameraBtn.disabled = true;
				} catch (error) {
					alert(`Error accessing camera: ${error instanceof Error ? error.message : "Unknown error"}`);
				}
			});

			captureBtn.addEventListener("click", async () => {
				const context = canvas.getContext("2d");
				if (!context) return;

				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				context.drawImage(video, 0, 0);

				canvas.toBlob(async (blob) => {
					if (blob) {
						capturedBlob = blob;

						// Stop the camera stream
						if (stream) {
							stream.getTracks().forEach(track => track.stop());
						}

						// Hide camera and show loading
						hideCamera();
						showLoading();

						// Start the automatic workflow
						await processWorkflow();
					}
				}, "image/jpeg");
			});

			async function processWorkflow() {
				try {
					// Step 1: Analyze image with Moondream
					updateLoadingMessage("Analyzing image...");
					const moondreamResult = await analyzeImage();

					// Step 2: Extract JSON with OpenAI
					updateLoadingMessage("Extracting key information...");
					const extractedData = await extractJson(moondreamResult);

					// Step 3: Check Wikipedia
					updateLoadingMessage("Checking Wikipedia articles...");
					const wikipediaUrls = await checkWikipedia(extractedData);

					if (wikipediaUrls.length === 0) {
						throw new Error("No Wikipedia articles found");
					}

					// Step 4: Fetch Wikipedia text
					updateLoadingMessage("Fetching article content...");
					const wikiArticles = await fetchWikipediaText(wikipediaUrls);

					if (wikiArticles.length === 0) {
						throw new Error("No Wikipedia articles retrieved");
					}

					// Step 5: Summarize articles
					updateLoadingMessage("Summarizing articles...");
					const summaries = await summarizeText(wikiArticles);

					if (summaries.length === 0) {
						throw new Error("No summaries generated");
					}

					// Step 6: Generate visualization
					updateLoadingMessage("Generating visualization...");
					const html = await generateVisualization(summaries);

					// Display the final result
					showVisualization(html);
				} catch (error) {
					updateLoadingMessage(`Error: ${error instanceof Error ? error.message : "Unknown error"}`);
					console.error("Workflow error:", error);
				}
			}

			async function analyzeImage(): Promise<string> {
				if (!capturedBlob) throw new Error("No image captured");

				const formData = new FormData();
				formData.append("image", capturedBlob, "capture.jpg");

				const response = await fetch("/api/analyze", {
					method: "POST",
					body: formData,
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Analysis failed");
				}

				return typeof data.result === 'string' ? data.result : JSON.stringify(data.result);
			}

			async function extractJson(moondreamResult: string): Promise<{ items: string[] }> {
				const response = await fetch("/api/extract-json", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ result: moondreamResult }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Extraction failed");
				}

				return data.data;
			}

			async function checkWikipedia(extractedData: { items: string[] }): Promise<string[]> {
				const items = extractedData.items;

				if (!Array.isArray(items) || items.length !== 3) {
					throw new Error("Expected exactly 3 items from extraction");
				}

				const response = await fetch("/api/check-wikipedia", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ items }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Wikipedia check failed");
				}

				const urls: string[] = [];
				for (const result of data.results) {
					if (result.exists) {
						urls.push(result.url);
					}
				}

				return urls;
			}

			async function fetchWikipediaText(urls: string[]): Promise<WikiArticle[]> {
				const response = await fetch("/api/fetch-wikipedia-text", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ urls }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Failed to fetch Wikipedia text");
				}

				const articles: WikiArticle[] = [];
				for (const result of data.results) {
					if (!result.error && result.title && result.text) {
						articles.push({
							title: result.title,
							text: result.text
						});
					}
				}

				return articles;
			}

			async function summarizeText(articles: WikiArticle[]): Promise<Summary[]> {
				const response = await fetch("/api/summarize-text", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ articles }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Failed to summarize articles");
				}

				const summaries: Summary[] = [];
				for (const result of data.results) {
					if (!result.error && result.title && result.summary) {
						summaries.push({
							title: result.title,
							summary: result.summary
						});
					}
				}

				return summaries;
			}

			async function generateVisualization(summaries: Summary[]): Promise<string> {
				const response = await fetch("/api/generate-visualization", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ summaries }),
				});

				const data = await response.json();

				if (!response.ok) {
					throw new Error(data.error || "Failed to generate visualization");
				}

				return data.html;
			}

			function showVisualization(html: string) {
				// Hide camera container completely
				cameraContainer.style.display = "none";

				// Create and display iframe with inline styles
				visualizationContainer.innerHTML = "";
				const iframe = document.createElement("iframe");
				iframe.srcdoc = html;
				iframe.style.width = "100%";
				iframe.style.height = "100%";
				iframe.style.border = "none";
				iframe.style.margin = "0";
				iframe.style.padding = "0";
				iframe.style.display = "block";
				visualizationContainer.appendChild(iframe);
				visualizationContainer.style.display = "block";
			}
		</script>
	</body>
</html>
